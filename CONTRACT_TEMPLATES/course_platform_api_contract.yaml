# ============================================================
# 線上課程平台 MVP API Contract (OpenAPI 3.0)
# ============================================================
# 使用說明：
# 1. 在 Day 1 契約定義日，由各模組 API Owner 建立/更新此文件
# 2. 前後端 Owner 共同 Review 並簽核
# 3. 契約確定後，雙方可平行開發
# ============================================================
# 對應 WBS 任務：
# - 1.0 環境架設與資料庫建立
# - 2.0 用戶認證系統 (Google SSO)
# - 3.0 課程內容展示
# - 4.0 內容管理與上傳
# - 5.0 影片播放功能
# ============================================================

openapi: 3.0.3
info:
  title: "線上課程平台 MVP API Contract"
  description: |
    ## 契約資訊
    - **契約版本**: v1.0.0
    - **建立日期**: 2025-12-29
    - **後端 Owner**: 冠瑋、Celia、子科
    - **前端 Owner**: 古古、Jane

    ## 契約狀態
    - [x] Draft (草稿)
    - [ ] Review (審核中)
    - [ ] Approved (已核准)
    - [ ] Frozen (已凍結，禁止變更)

    ## 變更歷史
    | 版本 | 日期 | 變更者 | 變更內容 |
    |------|------|--------|----------|
    | v1.0.0 | 2025-12-29 | 冠瑋 | 初始版本，涵蓋 MVP 五大核心功能 |

    ## 模組負責人
    | 模組 | 後端 Owner | 前端 Owner | WBS 任務 |
    |------|------------|------------|----------|
    | Auth | Celia | 古古 & Jane | 2.1.B, 2.2.B, 2.3.F |
    | Courses | 子科 | 古古 & Jane | 3.1.B, 3.2.F, 3.3.F |
    | Videos/Upload | 冠瑋 | 古古 & Jane | 4.1.B, 4.2.B, 4.3.F |
    | Playback | Celia | 古古 & Jane | 5.1.B, 5.2.F |
  version: "1.0.0"
  contact:
    name: 冠瑋 (Tech Lead)
    email: kuanwei@example.com

servers:
  - url: http://localhost:8000/api/v1
    description: Development server (本地端)
  - url: https://staging-api.courseplatform.com/v1
    description: Staging server
  - url: https://api.courseplatform.com/v1
    description: Production server

# ============================================================
# 標籤定義 - 用於分組 API 端點
# ============================================================
tags:
  - name: Auth
    description: |
      用戶認證相關操作 (WBS 2.0)
      - **Backend Owner**: Celia
      - **任務**: 2.1.B Google OAuth2 集成, 2.2.B 權限驗證中間件
  - name: Users
    description: |
      用戶資料操作
      - **Backend Owner**: Celia
      - **依賴模組**: Auth
  - name: Courses
    description: |
      課程瀏覽與詳情 (WBS 3.0)
      - **Backend Owner**: 子科
      - **任務**: 3.1.B 課程搜尋與詳情 API
  - name: Videos
    description: |
      影片上傳與管理 (WBS 4.0)
      - **Backend Owner**: 冠瑋
      - **任務**: 4.1.B GCS Signed URL, 4.2.B 雲端轉碼
  - name: Playback
    description: |
      影片播放功能 (WBS 5.0)
      - **Backend Owner**: Celia
      - **任務**: 5.1.B 影音資源安全 URL
  - name: Enrollments
    description: |
      課程報名管理
      - **Backend Owner**: 子科

# ============================================================
# API 端點定義
# ============================================================
paths:
  # ==========================================================
  # 認證模組 (Auth) - Owner: Celia
  # ==========================================================
  /auth/google:
    post:
      tags:
        - Auth
      summary: Google OAuth2 登入
      description: |
        ### 契約說明
        - **請求方**: Frontend (登入頁面)
        - **提供方**: Backend (Celia)
        - **WBS 任務**: 2.1.B
        - **整合優先級**: P0 (Week 2 必須完成)

        ### 流程
        1. 前端使用 Google SDK 取得 ID Token
        2. 將 ID Token 傳送至後端驗證
        3. 後端驗證成功後創建/匹配本地用戶
        4. 回傳 JWT Access Token 與 Refresh Token
      operationId: googleAuth
      security: []  # 此端點不需要認證
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GoogleAuthRequest'
            example:
              idToken: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: 登入成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              example:
                success: true
                data:
                  accessToken: "eyJhbGciOiJIUzI1NiIs..."
                  refreshToken: "dGhpcyBpcyBhIHJlZnJlc2g..."
                  expiresIn: 3600
                  user:
                    id: "usr_abc123"
                    email: "user@gmail.com"
                    name: "王小明"
                    avatar: "https://lh3.googleusercontent.com/..."
                    role: "student"
        '400':
          description: ID Token 無效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "INVALID_TOKEN"
                  message: "Google ID Token 驗證失敗"
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/refresh:
    post:
      tags:
        - Auth
      summary: 刷新 Access Token
      description: |
        ### 契約說明
        - **請求方**: Frontend
        - **提供方**: Backend (Celia)
        - **整合優先級**: P1
      operationId: refreshToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: Refresh Token
      responses:
        '200':
          description: 刷新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Refresh Token 無效或已過期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "INVALID_REFRESH_TOKEN"
                  message: "Refresh Token 無效或已過期，請重新登入"

  /auth/logout:
    post:
      tags:
        - Auth
      summary: 登出
      description: |
        ### 契約說明
        - **請求方**: Frontend
        - **提供方**: Backend (Celia)
      operationId: logout
      responses:
        '200':
          description: 登出成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /auth/me:
    get:
      tags:
        - Auth
      summary: 取得當前用戶資訊
      description: |
        ### 契約說明
        - **請求方**: Frontend
        - **提供方**: Backend (Celia)
        - **用途**: 頁面載入時驗證登入狀態
      operationId: getCurrentUser
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ==========================================================
  # 用戶模組 (Users)
  # ==========================================================
  /users/{userId}:
    get:
      tags:
        - Users
      summary: 取得用戶公開資料
      description: |
        ### 契約說明
        - **請求方**: Frontend (講師資訊顯示)
        - **提供方**: Backend
        - **用途**: 顯示課程作者/講師資訊
      operationId: getUserById
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublicResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Users
      summary: 更新用戶資料
      description: 只能更新自己的資料
      operationId: updateUser
      parameters:
        - $ref: '#/components/parameters/UserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==========================================================
  # 課程模組 (Courses) - Owner: 子科
  # ==========================================================
  /courses:
    get:
      tags:
        - Courses
      summary: 取得課程列表
      description: |
        ### 契約說明
        - **請求方**: Frontend (課程首頁 Dashboard)
        - **提供方**: Backend (子科)
        - **WBS 任務**: 3.1.B, 3.2.F
        - **整合優先級**: P1

        ### 功能
        - 分頁功能
        - 關鍵字搜尋 (標題、描述)
        - 分類篩選
      operationId: getCourses
      security: []  # 公開 API，不需登入
      parameters:
        - name: page
          in: query
          description: 頁碼 (從 1 開始)
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: 每頁筆數
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 12
        - name: search
          in: query
          description: 搜尋關鍵字 (標題、描述)
          schema:
            type: string
            maxLength: 100
        - name: category
          in: query
          description: 分類 ID
          schema:
            type: string
        - name: sortBy
          in: query
          description: 排序欄位
          schema:
            type: string
            enum: [createdAt, title, enrollmentCount]
            default: createdAt
        - name: sortOrder
          in: query
          description: 排序方向
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: 成功取得課程列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseListResponse'
              example:
                success: true
                data:
                  courses:
                    - id: "crs_abc123"
                      title: "Python 入門到精通"
                      description: "從零開始學習 Python 程式設計..."
                      thumbnail: "https://cdn.example.com/thumbnails/python.jpg"
                      instructor:
                        id: "usr_inst001"
                        name: "李老師"
                        avatar: "https://cdn.example.com/avatars/li.jpg"
                      duration: 36000
                      videoCount: 24
                      enrollmentCount: 1250
                      status: "published"
                      createdAt: "2025-01-15T10:30:00Z"
                  pagination:
                    page: 1
                    limit: 12
                    total: 48
                    totalPages: 4
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Courses
      summary: 建立新課程
      description: |
        ### 契約說明
        - **請求方**: Frontend (講師後台)
        - **提供方**: Backend (子科)
        - **權限**: 僅 instructor 角色可使用
        - **WBS 任務**: 4.0 內容管理
      operationId: createCourse
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCourseRequest'
      responses:
        '201':
          description: 課程建立成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: 非講師角色
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "INSTRUCTOR_REQUIRED"
                  message: "只有講師可以建立課程"

  /courses/{courseId}:
    get:
      tags:
        - Courses
      summary: 取得課程詳情
      description: |
        ### 契約說明
        - **請求方**: Frontend (課程詳情頁)
        - **提供方**: Backend (子科)
        - **WBS 任務**: 3.1.B, 3.3.F
        - **整合優先級**: P1

        ### 回傳內容
        - 課程基本資訊
        - 講師資料
        - 影片列表 (含 Metadata，不含播放 URL)
        - 課程大綱結構
      operationId: getCourseById
      security: []  # 公開 API
      parameters:
        - $ref: '#/components/parameters/CourseId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseDetailResponse'
              example:
                success: true
                data:
                  id: "crs_abc123"
                  title: "Python 入門到精通"
                  description: "完整的 Python 學習課程，從基礎語法到進階應用..."
                  thumbnail: "https://cdn.example.com/thumbnails/python.jpg"
                  instructor:
                    id: "usr_inst001"
                    name: "李老師"
                    avatar: "https://cdn.example.com/avatars/li.jpg"
                    bio: "10年程式教學經驗"
                  duration: 36000
                  videoCount: 24
                  enrollmentCount: 1250
                  status: "published"
                  sections:
                    - id: "sec_001"
                      title: "第一章：Python 基礎"
                      order: 1
                      videos:
                        - id: "vid_001"
                          title: "1-1 安裝開發環境"
                          duration: 600
                          order: 1
                          status: "ready"
                        - id: "vid_002"
                          title: "1-2 Hello World"
                          duration: 480
                          order: 2
                          status: "ready"
                  createdAt: "2025-01-15T10:30:00Z"
                  updatedAt: "2025-01-20T14:00:00Z"
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Courses
      summary: 更新課程資訊
      description: 僅課程擁有者可更新
      operationId: updateCourse
      parameters:
        - $ref: '#/components/parameters/CourseId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCourseRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseResponse'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Courses
      summary: 刪除課程
      description: 僅課程擁有者可刪除，已有學員報名的課程無法刪除
      operationId: deleteCourse
      parameters:
        - $ref: '#/components/parameters/CourseId'
      responses:
        '204':
          description: 刪除成功
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: 課程已有學員，無法刪除
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "COURSE_HAS_ENROLLMENTS"
                  message: "課程已有學員報名，無法刪除"

  # ==========================================================
  # 影片上傳模組 (Videos) - Owner: 冠瑋
  # ==========================================================
  /courses/{courseId}/videos:
    get:
      tags:
        - Videos
      summary: 取得課程影片列表
      description: |
        ### 契約說明
        - **請求方**: Frontend (講師後台)
        - **提供方**: Backend (冠瑋)
        - **用途**: 管理課程影片
      operationId: getCourseVideos
      parameters:
        - $ref: '#/components/parameters/CourseId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoListResponse'

    post:
      tags:
        - Videos
      summary: 建立影片記錄 (取得上傳 URL)
      description: |
        ### 契約說明
        - **請求方**: Frontend (影片上傳儀表板)
        - **提供方**: Backend (冠瑋)
        - **WBS 任務**: 4.1.B GCS Signed URL 上傳機制
        - **整合優先級**: P1

        ### 流程
        1. 前端呼叫此 API 建立影片記錄
        2. 後端生成 GCS Signed URL (分段上傳)
        3. 前端使用 Signed URL 直接上傳至 GCS
        4. 上傳完成後，GCS 觸發轉碼 Pipeline
        5. 轉碼完成後，後端透過 Webhook 更新影片狀態
      operationId: createVideo
      parameters:
        - $ref: '#/components/parameters/CourseId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVideoRequest'
            example:
              title: "1-1 安裝開發環境"
              sectionId: "sec_001"
              filename: "setup-guide.mp4"
              fileSize: 524288000
              mimeType: "video/mp4"
      responses:
        '201':
          description: 影片記錄建立成功，回傳上傳 URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoUploadResponse'
              example:
                success: true
                data:
                  id: "vid_new001"
                  title: "1-1 安裝開發環境"
                  status: "pending_upload"
                  upload:
                    uploadId: "upload_xyz789"
                    signedUrl: "https://storage.googleapis.com/bucket/..."
                    expiresAt: "2025-12-29T20:00:00Z"
                    chunkSize: 5242880
                    totalChunks: 100
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  /videos/{videoId}:
    get:
      tags:
        - Videos
      summary: 取得影片詳情
      operationId: getVideoById
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Videos
      summary: 更新影片資訊
      operationId: updateVideo
      parameters:
        - $ref: '#/components/parameters/VideoId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateVideoRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Videos
      summary: 刪除影片
      operationId: deleteVideo
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '204':
          description: 刪除成功
        '404':
          $ref: '#/components/responses/NotFound'

  /videos/{videoId}/upload/complete:
    post:
      tags:
        - Videos
      summary: 通知上傳完成
      description: |
        ### 契約說明
        - **請求方**: Frontend (上傳完成後)
        - **提供方**: Backend (冠瑋)
        - **用途**: 前端上傳完成後通知後端開始轉碼
      operationId: completeVideoUpload
      parameters:
        - $ref: '#/components/parameters/VideoId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - uploadId
              properties:
                uploadId:
                  type: string
                  description: 上傳 ID
      responses:
        '200':
          description: 已開始轉碼
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoResponse'
              example:
                success: true
                data:
                  id: "vid_new001"
                  status: "transcoding"
                  message: "影片正在轉碼中，預計需要 5-10 分鐘"

  /videos/{videoId}/status:
    get:
      tags:
        - Videos
      summary: 查詢影片處理狀態
      description: |
        ### 契約說明
        - **請求方**: Frontend (輪詢狀態)
        - **提供方**: Backend (冠瑋)
        - **WBS 任務**: 4.2.B 雲端轉碼 Pipeline
        - **用途**: 前端輪詢影片轉碼進度
      operationId: getVideoStatus
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoStatusResponse'
              example:
                success: true
                data:
                  id: "vid_new001"
                  status: "transcoding"
                  progress: 65
                  resolutions:
                    - resolution: "720p"
                      status: "completed"
                    - resolution: "1080p"
                      status: "processing"
                  estimatedCompletion: "2025-12-29T19:30:00Z"

  # ==========================================================
  # 影片播放模組 (Playback) - Owner: Celia
  # ==========================================================
  /videos/{videoId}/playback:
    get:
      tags:
        - Playback
      summary: 取得影片播放資訊
      description: |
        ### 契約說明
        - **請求方**: Frontend (HLS 播放器)
        - **提供方**: Backend (Celia)
        - **WBS 任務**: 5.1.B 影音資源安全 URL 發放
        - **整合優先級**: P0

        ### 安全機制
        - 驗證用戶是否有權觀看 (已報名課程)
        - 生成帶 Token 的 CDN 播放路徑
        - URL 有效期限 4 小時
      operationId: getPlaybackInfo
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '200':
          description: 成功，回傳安全播放 URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaybackResponse'
              example:
                success: true
                data:
                  videoId: "vid_001"
                  title: "1-1 安裝開發環境"
                  duration: 600
                  hlsUrl: "https://cdn.example.com/hls/vid_001/master.m3u8?token=xyz..."
                  resolutions:
                    - label: "720p"
                      url: "https://cdn.example.com/hls/vid_001/720p.m3u8?token=xyz..."
                    - label: "1080p"
                      url: "https://cdn.example.com/hls/vid_001/1080p.m3u8?token=xyz..."
                  expiresAt: "2025-12-30T00:00:00Z"
                  progress:
                    position: 120
                    completed: false
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: 無權觀看此影片
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "NOT_ENROLLED"
                  message: "請先報名此課程"
        '404':
          $ref: '#/components/responses/NotFound'

  /videos/{videoId}/progress:
    get:
      tags:
        - Playback
      summary: 取得播放進度
      description: |
        ### 契約說明
        - **請求方**: Frontend
        - **提供方**: Backend (Celia)
        - **WBS 任務**: 5.2.F 斷點續看功能
      operationId: getVideoProgress
      parameters:
        - $ref: '#/components/parameters/VideoId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProgressResponse'

    put:
      tags:
        - Playback
      summary: 更新播放進度
      description: |
        ### 契約說明
        - **請求方**: Frontend (播放器定期回報)
        - **提供方**: Backend (Celia)
        - **WBS 任務**: 5.2.F 斷點續看功能
        - **建議頻率**: 每 10 秒回報一次
      operationId: updateVideoProgress
      parameters:
        - $ref: '#/components/parameters/VideoId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProgressRequest'
            example:
              position: 300
              duration: 600
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProgressResponse'

  # ==========================================================
  # 報名模組 (Enrollments)
  # ==========================================================
  /enrollments:
    get:
      tags:
        - Enrollments
      summary: 取得我的課程 (已報名)
      description: |
        ### 契約說明
        - **請求方**: Frontend (我的課程頁面)
        - **提供方**: Backend
      operationId: getMyEnrollments
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 12
        - name: status
          in: query
          description: 篩選課程狀態
          schema:
            type: string
            enum: [in_progress, completed, all]
            default: all
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnrollmentListResponse'

    post:
      tags:
        - Enrollments
      summary: 報名課程
      description: |
        ### 契約說明
        - **請求方**: Frontend (課程詳情頁)
        - **提供方**: Backend
      operationId: enrollCourse
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - courseId
              properties:
                courseId:
                  type: string
                  description: 課程 ID
      responses:
        '201':
          description: 報名成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnrollmentResponse'
        '409':
          description: 已報名過此課程
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "ALREADY_ENROLLED"
                  message: "您已報名此課程"

  /enrollments/{courseId}:
    get:
      tags:
        - Enrollments
      summary: 查詢報名狀態
      operationId: getEnrollmentStatus
      parameters:
        - $ref: '#/components/parameters/CourseId'
      responses:
        '200':
          description: 已報名
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnrollmentResponse'
        '404':
          description: 未報名
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "NOT_ENROLLED"
                  message: "尚未報名此課程"

# ============================================================
# 共用元件定義
# ============================================================
components:
  # ----------------------------------------------------------
  # 資料模型 (Schemas)
  # ----------------------------------------------------------
  schemas:
    # ========== 基礎回應格式 ==========
    BaseResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: 請求是否成功

    SuccessResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            message:
              type: string

    ErrorResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - error
          properties:
            error:
              type: object
              required:
                - code
                - message
              properties:
                code:
                  type: string
                  description: 錯誤代碼
                message:
                  type: string
                  description: 錯誤訊息
                details:
                  type: array
                  items:
                    type: object
                    properties:
                      field:
                        type: string
                      message:
                        type: string

    Pagination:
      type: object
      required:
        - page
        - limit
        - total
        - totalPages
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    # ========== 認證模組 ==========
    GoogleAuthRequest:
      type: object
      required:
        - idToken
      properties:
        idToken:
          type: string
          description: Google OAuth2 ID Token

    AuthResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              type: object
              required:
                - accessToken
                - refreshToken
                - expiresIn
                - user
              properties:
                accessToken:
                  type: string
                  description: JWT Access Token
                refreshToken:
                  type: string
                  description: Refresh Token
                expiresIn:
                  type: integer
                  description: Access Token 有效秒數
                user:
                  $ref: '#/components/schemas/User'

    # ========== 用戶模組 ==========
    User:
      type: object
      required:
        - id
        - email
        - name
        - role
        - createdAt
      properties:
        id:
          type: string
          pattern: '^usr_[a-zA-Z0-9]+$'
          example: "usr_abc123"
        email:
          type: string
          format: email
        name:
          type: string
          maxLength: 100
        avatar:
          type: string
          format: uri
          nullable: true
        role:
          type: string
          enum: [student, instructor, admin]
          description: |
            - student: 學生
            - instructor: 講師 (可建立課程)
            - admin: 管理員
        bio:
          type: string
          maxLength: 500
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              $ref: '#/components/schemas/User'

    UserPublicResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              type: object
              properties:
                id:
                  type: string
                name:
                  type: string
                avatar:
                  type: string
                  nullable: true
                bio:
                  type: string
                  nullable: true
                courseCount:
                  type: integer
                  description: 開設課程數

    UpdateUserRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
        bio:
          type: string
          maxLength: 500

    # ========== 課程模組 ==========
    Course:
      type: object
      required:
        - id
        - title
        - instructorId
        - status
        - createdAt
      properties:
        id:
          type: string
          pattern: '^crs_[a-zA-Z0-9]+$'
        title:
          type: string
          maxLength: 200
        description:
          type: string
          maxLength: 2000
        thumbnail:
          type: string
          format: uri
          nullable: true
        instructorId:
          type: string
        duration:
          type: integer
          description: 總時長 (秒)
        videoCount:
          type: integer
        enrollmentCount:
          type: integer
        status:
          type: string
          enum: [draft, published, archived]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CourseWithInstructor:
      allOf:
        - $ref: '#/components/schemas/Course'
        - type: object
          properties:
            instructor:
              type: object
              properties:
                id:
                  type: string
                name:
                  type: string
                avatar:
                  type: string
                  nullable: true

    CourseListResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              type: object
              required:
                - courses
                - pagination
              properties:
                courses:
                  type: array
                  items:
                    $ref: '#/components/schemas/CourseWithInstructor'
                pagination:
                  $ref: '#/components/schemas/Pagination'

    CourseResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              $ref: '#/components/schemas/CourseWithInstructor'

    CourseDetailResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              allOf:
                - $ref: '#/components/schemas/CourseWithInstructor'
                - type: object
                  properties:
                    sections:
                      type: array
                      items:
                        $ref: '#/components/schemas/Section'

    Section:
      type: object
      required:
        - id
        - title
        - order
      properties:
        id:
          type: string
          pattern: '^sec_[a-zA-Z0-9]+$'
        title:
          type: string
        order:
          type: integer
        videos:
          type: array
          items:
            $ref: '#/components/schemas/VideoMeta'

    CreateCourseRequest:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 2000
        thumbnail:
          type: string
          format: uri

    UpdateCourseRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 200
        description:
          type: string
          maxLength: 2000
        thumbnail:
          type: string
          format: uri
        status:
          type: string
          enum: [draft, published, archived]

    # ========== 影片模組 ==========
    VideoMeta:
      type: object
      description: 影片元資料 (不含播放 URL)
      required:
        - id
        - title
        - order
        - status
      properties:
        id:
          type: string
          pattern: '^vid_[a-zA-Z0-9]+$'
        title:
          type: string
        duration:
          type: integer
          description: 時長 (秒)
        order:
          type: integer
        status:
          type: string
          enum: [pending_upload, uploading, transcoding, ready, failed]
          description: |
            - pending_upload: 等待上傳
            - uploading: 上傳中
            - transcoding: 轉碼中
            - ready: 就緒可播放
            - failed: 處理失敗
        thumbnail:
          type: string
          format: uri
          nullable: true

    Video:
      allOf:
        - $ref: '#/components/schemas/VideoMeta'
        - type: object
          properties:
            courseId:
              type: string
            sectionId:
              type: string
            originalFilename:
              type: string
            fileSize:
              type: integer
              description: 檔案大小 (bytes)
            createdAt:
              type: string
              format: date-time
            updatedAt:
              type: string
              format: date-time

    VideoListResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              type: object
              required:
                - videos
              properties:
                videos:
                  type: array
                  items:
                    $ref: '#/components/schemas/Video'

    VideoResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              $ref: '#/components/schemas/Video'

    CreateVideoRequest:
      type: object
      required:
        - title
        - filename
        - fileSize
        - mimeType
      properties:
        title:
          type: string
          maxLength: 200
        sectionId:
          type: string
          description: 所屬章節 ID
        filename:
          type: string
          description: 原始檔名
        fileSize:
          type: integer
          description: 檔案大小 (bytes)
          maximum: 5368709120  # 5GB
        mimeType:
          type: string
          enum: [video/mp4, video/quicktime, video/x-msvideo]

    UpdateVideoRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 200
        sectionId:
          type: string
        order:
          type: integer

    VideoUploadResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              type: object
              required:
                - id
                - status
                - upload
              properties:
                id:
                  type: string
                title:
                  type: string
                status:
                  type: string
                upload:
                  type: object
                  required:
                    - uploadId
                    - signedUrl
                    - expiresAt
                  properties:
                    uploadId:
                      type: string
                      description: 上傳 ID，完成後需回傳
                    signedUrl:
                      type: string
                      format: uri
                      description: GCS Signed URL
                    expiresAt:
                      type: string
                      format: date-time
                    chunkSize:
                      type: integer
                      description: 建議分段大小 (bytes)
                    totalChunks:
                      type: integer
                      description: 預計分段數

    VideoStatusResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              type: object
              required:
                - id
                - status
              properties:
                id:
                  type: string
                status:
                  type: string
                  enum: [pending_upload, uploading, transcoding, ready, failed]
                progress:
                  type: integer
                  minimum: 0
                  maximum: 100
                  description: 轉碼進度百分比
                resolutions:
                  type: array
                  items:
                    type: object
                    properties:
                      resolution:
                        type: string
                        enum: ["720p", "1080p"]
                      status:
                        type: string
                        enum: [pending, processing, completed, failed]
                estimatedCompletion:
                  type: string
                  format: date-time
                errorMessage:
                  type: string
                  description: 失敗時的錯誤訊息

    # ========== 播放模組 ==========
    PlaybackResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              type: object
              required:
                - videoId
                - hlsUrl
                - expiresAt
              properties:
                videoId:
                  type: string
                title:
                  type: string
                duration:
                  type: integer
                hlsUrl:
                  type: string
                  format: uri
                  description: HLS 主播放清單 URL (帶 Token)
                resolutions:
                  type: array
                  items:
                    type: object
                    properties:
                      label:
                        type: string
                      url:
                        type: string
                        format: uri
                expiresAt:
                  type: string
                  format: date-time
                  description: URL 有效期限
                progress:
                  $ref: '#/components/schemas/Progress'

    Progress:
      type: object
      properties:
        position:
          type: integer
          description: 播放位置 (秒)
        completed:
          type: boolean
          description: 是否已完成觀看

    ProgressResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              $ref: '#/components/schemas/Progress'

    UpdateProgressRequest:
      type: object
      required:
        - position
      properties:
        position:
          type: integer
          minimum: 0
          description: 當前播放位置 (秒)
        duration:
          type: integer
          description: 影片總長度 (秒)，用於計算完成狀態

    # ========== 報名模組 ==========
    Enrollment:
      type: object
      required:
        - id
        - userId
        - courseId
        - enrolledAt
      properties:
        id:
          type: string
          pattern: '^enr_[a-zA-Z0-9]+$'
        userId:
          type: string
        courseId:
          type: string
        progress:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: 課程完成進度百分比
        completedVideos:
          type: integer
        totalVideos:
          type: integer
        enrolledAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true

    EnrollmentWithCourse:
      allOf:
        - $ref: '#/components/schemas/Enrollment'
        - type: object
          properties:
            course:
              $ref: '#/components/schemas/CourseWithInstructor'

    EnrollmentListResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              type: object
              required:
                - enrollments
                - pagination
              properties:
                enrollments:
                  type: array
                  items:
                    $ref: '#/components/schemas/EnrollmentWithCourse'
                pagination:
                  $ref: '#/components/schemas/Pagination'

    EnrollmentResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          required:
            - data
          properties:
            data:
              $ref: '#/components/schemas/Enrollment'

  # ----------------------------------------------------------
  # 共用參數
  # ----------------------------------------------------------
  parameters:
    UserId:
      name: userId
      in: path
      description: 用戶 ID
      required: true
      schema:
        type: string
        pattern: '^usr_[a-zA-Z0-9]+$'

    CourseId:
      name: courseId
      in: path
      description: 課程 ID
      required: true
      schema:
        type: string
        pattern: '^crs_[a-zA-Z0-9]+$'

    VideoId:
      name: videoId
      in: path
      description: 影片 ID
      required: true
      schema:
        type: string
        pattern: '^vid_[a-zA-Z0-9]+$'

  # ----------------------------------------------------------
  # 共用回應
  # ----------------------------------------------------------
  responses:
    BadRequest:
      description: 請求參數錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: "VALIDATION_ERROR"
              message: "請求參數驗證失敗"
              details:
                - field: "title"
                  message: "標題為必填欄位"

    Unauthorized:
      description: 未授權 (未登入或 Token 無效)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: "UNAUTHORIZED"
              message: "請先登入"

    Forbidden:
      description: 禁止存取 (權限不足)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: "FORBIDDEN"
              message: "您沒有權限執行此操作"

    NotFound:
      description: 資源不存在
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: "NOT_FOUND"
              message: "找不到指定的資源"

    InternalError:
      description: 伺服器錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: "INTERNAL_ERROR"
              message: "伺服器發生錯誤，請稍後再試"

  # ----------------------------------------------------------
  # 安全機制
  # ----------------------------------------------------------
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT Token 認證

        ### 取得方式
        透過 `/auth/google` 端點登入後取得

        ### 使用方式
        在 Header 中加入：
        ```
        Authorization: Bearer <access_token>
        ```

        ### Token 有效期
        - Access Token: 1 小時
        - Refresh Token: 7 天

# 全域安全設定 (預設需要認證，各端點可覆寫)
security:
  - BearerAuth: []
